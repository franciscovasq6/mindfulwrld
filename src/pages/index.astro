---
import { getCollection, getEntry } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import CircularBlogCard from '../components/CircularBlogCard.astro';
import InteractiveMap from '../components/InteractiveMap.astro';
import VideoEmbed from '../components/VideoEmbed.astro';

// Get all blog posts
const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Get featured posts
const featuredPosts = allPosts
  .filter(post => post.data.featured)
  .slice(0, 3);

// Fallback to latest 3 if no featured posts
const displayPosts = featuredPosts.length > 0 ? featuredPosts : sortedPosts.slice(0, 3);

// Get homepage content
const homeContent = await getEntry('pages', 'home');
const {
  title,
  aboutImage,
  videoId,
  videoTitle,
  instagram,
  instagramPersonal,
  snapchat,
  email,
  heroImages = []
} = homeContent.data;
const { Content: AboutContent } = await homeContent.render();

// Prepare map markers from posts with location data
const mapMarkers = allPosts
  .filter(post => post.data.location)
  .map(post => ({
    lat: post.data.location!.lat,
    lng: post.data.location!.lng,
    title: post.data.location!.name,
    url: `/blog/${post.slug}`
  }));

// Get resource images (recent posts with images)
const resourceImages = sortedPosts
  .filter(post => post.data.heroImage)
  .slice(0, 8)
  .map(post => ({
    image: post.data.heroImage!,
    title: post.data.title,
    url: `/blog/${post.slug}`
  }));
---

<BaseLayout
  title={title}
  description="Travel blog by Margarita - exploring the world one destination at a time"
>
  <!-- Hero Section with Image Collage -->
  <section class="hero-collage">
    <div class="hero-grid">
      {heroImages.map((image, index) => (
        <div class={`hero-image hero-image-${index + 1}`}>
          <img src={image} alt={`Travel destination ${index + 1}`} />
        </div>
      ))}
    </div>
    <div class="hero-title-overlay">
      <h1>{title}</h1>
    </div>
  </section>

  <!-- Featured Posts -->
  <section class="featured-section">
    <div class="container">
      <h2>Featured Posts</h2>
      <div class="featured-grid">
        {displayPosts.map((post) => (
          <CircularBlogCard
            title={post.data.title}
            description={post.data.description}
            image={post.data.heroImage}
            url={`/blog/${post.slug}`}
          />
        ))}
      </div>
    </div>
  </section>

  <!-- Interactive World Map -->
  {mapMarkers.length > 0 && (
    <section class="map-section">
      <div class="container">
        <InteractiveMap markers={mapMarkers} />
      </div>
    </section>
  )}

  <!-- About Me Section -->
  <section class="about-section">
    <div class="container">
      <div class="about-content">
        <div class="about-text">
          <h2>About Me</h2>
          <div class="prose">
            <AboutContent />
          </div>
        </div>
        <div class="about-image-container">
          <div class="about-image-circle">
            {aboutImage ? (
              <img src={aboutImage} alt="Margarita" />
            ) : (
              <div class="placeholder-circle"></div>
            )}
            <div class="circle-name">Margarita</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Resources Section -->
  {resourceImages.length > 0 && (
    <section class="resources-section">
      <div class="container">
        <h2>Resources</h2>
        <div class="resources-grid">
          {resourceImages.map((resource) => (
            <a href={resource.url} class="resource-item">
              <img src={resource.image} alt={resource.title} />
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Latest Video -->
  {videoId && (
    <section class="video-section">
      <div class="container">
        <h2>Latest Video</h2>
        <div class="video-wrapper">
          <VideoEmbed videoId={videoId} title={videoTitle} />
        </div>
      </div>
    </section>
  )}

  <!-- Socials Section -->
  <section class="socials-section">
    <div class="container">
      <div class="socials-content">
        <div class="lets-chat-circle">
          <div class="circle-text">Let's Chat!</div>
          <div class="circle-image">
            <img src="/images/chat-image.jpg" alt="Let's connect" />
          </div>
        </div>
        <div class="socials-info">
          <h2>Socials</h2>
          <div class="social-links">
            {instagram && (
              <div class="social-item">
                <strong>INSTAGRAM:</strong><br />
                <a href={`https://instagram.com/${instagram.replace('@', '')}`} target="_blank">
                  {instagram}
                </a>
              </div>
            )}
            {instagramPersonal && (
              <div class="social-item">
                <a href={`https://instagram.com/${instagramPersonal.replace('@', '')}`} target="_blank">
                  {instagramPersonal} (personal)
                </a>
              </div>
            )}
            {snapchat && (
              <div class="social-item">
                <strong>Snapchat:</strong><br />
                <a href={`https://snapchat.com/add/${snapchat.replace('@', '')}`} target="_blank">
                  {snapchat}
                </a>
              </div>
            )}
            {email && (
              <div class="social-item">
                <strong>Email Address:</strong><br />
                <a href={`mailto:${email}`}>{email}</a>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  /* Hero Collage */
  .hero-collage {
    position: relative;
    height: 70vh;
    min-height: 500px;
    overflow: hidden;
  }

  .hero-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    height: 100%;
  }

  .hero-image {
    overflow: hidden;
  }

  .hero-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .hero-title-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
  }

  .hero-title-overlay h1 {
    font-family: 'Brush Script MT', cursive, var(--font-serif);
    font-size: clamp(3rem, 10vw, 8rem);
    color: white;
    text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
    margin: 0;
    white-space: nowrap;
  }

  /* Featured Section */
  .featured-section {
    padding: var(--space-20) 0;
    background-color: var(--color-background);
  }

  .featured-section h2 {
    text-align: center;
    font-size: var(--font-size-3xl);
    margin-bottom: var(--space-12);
    color: var(--color-black);
  }

  .featured-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-12);
    justify-items: center;
    max-width: 900px;
    margin: 0 auto;
  }

  /* Map Section */
  .map-section {
    padding: var(--space-16) 0;
    background-color: white;
  }

  /* About Section */
  .about-section {
    padding: var(--space-20) 0;
    background-color: var(--color-background);
  }

  .about-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-16);
    align-items: center;
  }

  .about-text h2 {
    font-size: var(--font-size-3xl);
    margin-bottom: var(--space-6);
    color: var(--color-black);
  }

  .about-image-container {
    display: flex;
    justify-content: center;
  }

  .about-image-circle {
    position: relative;
    width: 350px;
    height: 350px;
  }

  .about-image-circle img,
  .placeholder-circle {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: 8px solid white;
    box-shadow: var(--shadow-xl);
  }

  .placeholder-circle {
    background: linear-gradient(135deg, #E2689E, #61CE70);
  }

  .circle-name {
    position: absolute;
    top: 20%;
    right: -15%;
    background-color: #E2689E;
    color: white;
    padding: var(--space-4) var(--space-8);
    border-radius: 50px;
    font-family: 'Brush Script MT', cursive, var(--font-serif);
    font-size: var(--font-size-3xl);
    transform: rotate(-15deg);
    box-shadow: var(--shadow-md);
  }

  /* Resources Section */
  .resources-section {
    padding: var(--space-20) 0;
    background-color: white;
  }

  .resources-section h2 {
    text-align: center;
    font-size: var(--font-size-3xl);
    margin-bottom: var(--space-12);
  }

  .resources-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--space-4);
  }

  .resource-item {
    aspect-ratio: 1;
    overflow: hidden;
    border-radius: var(--border-radius);
  }

  .resource-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-base);
  }

  .resource-item:hover img {
    transform: scale(1.1);
  }

  /* Video Section */
  .video-section {
    padding: var(--space-20) 0;
    background-color: var(--color-background);
  }

  .video-section h2 {
    text-align: center;
    font-size: var(--font-size-3xl);
    margin-bottom: var(--space-12);
  }

  .video-wrapper {
    max-width: 800px;
    margin: 0 auto;
  }

  /* Socials Section */
  .socials-section {
    padding: var(--space-20) 0;
    background-color: white;
  }

  .socials-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-16);
    align-items: center;
  }

  .lets-chat-circle {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 0 auto;
  }

  .circle-text {
    position: absolute;
    top: -10%;
    left: -15%;
    background-color: #E2689E;
    color: white;
    padding: var(--space-6) var(--space-12);
    border-radius: 50px 50px 0 50px;
    font-family: 'Brush Script MT', cursive, var(--font-serif);
    font-size: var(--font-size-3xl);
    transform: rotate(-15deg);
    box-shadow: var(--shadow-lg);
    z-index: 2;
  }

  .circle-image {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    overflow: hidden;
    border: 6px solid white;
    box-shadow: var(--shadow-xl);
  }

  .circle-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .socials-info h2 {
    font-size: var(--font-size-3xl);
    margin-bottom: var(--space-6);
  }

  .social-links {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .social-item {
    font-size: var(--font-size-base);
    color: var(--color-secondary);
  }

  .social-item strong {
    color: var(--color-black);
  }

  .social-item a {
    color: var(--color-primary);
    text-decoration: none;
  }

  .social-item a:hover {
    text-decoration: underline;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .about-content,
    .socials-content {
      grid-template-columns: 1fr;
      text-align: center;
    }

    .about-image-circle {
      width: 250px;
      height: 250px;
    }

    .circle-name {
      right: 50%;
      transform: translateX(50%) rotate(-15deg);
      top: -10%;
    }
  }

  @media (max-width: 768px) {
    .hero-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .hero-title-overlay h1 {
      font-size: 3rem;
    }

    .featured-grid {
      grid-template-columns: 1fr;
    }

    .resources-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>
